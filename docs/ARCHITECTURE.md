# CHTL 架构设计

## 概述

CHTL（C++ Hypertext Language）是一个现代化的Web开发语言，旨在提供更直观、更强大的HTML/CSS/JavaScript编写方式。

## 核心设计原则

1. **模块化**: 各个组件相互独立，通过接口通信
2. **可扩展**: 易于添加新功能和语言特性
3. **高性能**: 使用C++17特性和优化技术
4. **零依赖**: 移除ANTLR4运行时依赖，生成独立可执行文件

## 系统架构

```
┌─────────────────────────────────────────────────┐
│                   用户接口层                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │
│  │ CLI工具  │  │VSCode插件│  │  Web IDE     │  │
│  └──────────┘  └──────────┘  └──────────────┘  │
└─────────────────────────────────────────────────┘
                         │
┌─────────────────────────────────────────────────┐
│                   编译器前端                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │
│  │  Scanner │  │  Parser  │  │  AST Builder │  │
│  └──────────┘  └──────────┘  └──────────────┘  │
└─────────────────────────────────────────────────┘
                         │
┌─────────────────────────────────────────────────┐
│                   核心系统                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │
│  │ Template │  │  Custom  │  │   Import     │  │
│  ├──────────┤  ├──────────┤  ├──────────────┤  │
│  │Namespace │  │  Origin  │  │  Constraint  │  │
│  └──────────┘  └──────────┘  └──────────────┘  │
└─────────────────────────────────────────────────┘
                         │
┌─────────────────────────────────────────────────┐
│                   代码生成器                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │
│  │   HTML   │  │   CSS    │  │  JavaScript  │  │
│  └──────────┘  └──────────┘  └──────────────┘  │
└─────────────────────────────────────────────────┘
                         │
┌─────────────────────────────────────────────────┐
│                   优化器                          │
│  ┌──────────┐  ┌──────────┐  ┌──────────────┐  │
│  │ JS优化器 │  │CSS优化器 │  │  模块打包器  │  │
│  └──────────┘  └──────────┘  └──────────────┘  │
└─────────────────────────────────────────────────┘
```

## 模块详解

### 1. Scanner（扫描器）
- **功能**: 将源代码分割成不同语言片段
- **特点**: 统一扫描器，支持CHTL、CSS、JS、CHTL JS混合语法
- **输出**: Token流，标记语言类型

### 2. Parser（解析器）
- **功能**: 将Token流转换为AST
- **技术**: 使用ANTLR4生成，但运行时不依赖ANTLR4
- **支持**: CHTL、CSS、JS、CHTL JS、配置语法

### 3. Template系统
- **功能**: 定义可重用的样式、元素和变量组
- **特性**: 
  - 参数化模板
  - 继承机制
  - 条件使用

### 4. Custom系统
- **功能**: 扩展和特化Template
- **特性**:
  - 删除/插入操作
  - 运行时变量覆盖
  - 与Template互相继承

### 5. Import系统
- **功能**: 模块化开发支持
- **支持格式**:
  - CHTL文件
  - CMOD/CJMOD模块
  - HTML/CSS/JS文件
  - 通配符导入

### 6. 代码生成器
- **HTML生成器**: 生成语义化HTML5
- **CSS生成器**: 支持现代CSS特性
- **JS生成器**: 支持ES6+语法

### 7. 优化器
- **JS优化**: 变量混淆、代码压缩、Tree Shaking
- **CSS优化**: 压缩、合并、去重
- **模块打包**: 依赖解析、代码分割、Source Map

## 配置系统

支持灵活的关键字定制：

```chtl
[Configuration] {
    DISABLE_NAME_GROUP = false;
    
    [Name] {
        KEYWORD_TEMPLATE = [Template, 模板, tpl];
        CUSTOM_STYLE = [@Style, @样式];
    }
}
```

## 性能优化

1. **字符串优化**:
   - StringBuilder减少拼接开销
   - StringView避免不必要的复制
   - 字符串池化

2. **内存管理**:
   - 内存池分配器
   - 对象池重用
   - RAII资源管理

3. **并行处理**:
   - 多文件并行编译
   - 并行模块解析
   - 异步I/O

4. **缓存机制**:
   - 正则表达式缓存
   - 解析结果缓存
   - 编译产物缓存

## 错误处理

统一的错误处理接口：

```cpp
// 错误级别
enum class ErrorLevel {
    Debug, Info, Warning, Error, Fatal
};

// 错误类别
enum class ErrorCategory {
    Syntax, Semantic, Type, Reference, 
    Import, Runtime, Internal, IO, Config
};
```

## 测试策略

1. **单元测试**: 覆盖所有核心模块
2. **集成测试**: 验证模块间交互
3. **性能测试**: 确保编译速度
4. **回归测试**: 防止功能退化

## 部署架构

```
chtl-compiler
├── bin/
│   └── chtl              # 主程序
├── lib/
│   └── chtl/             # 标准库
├── share/
│   ├── modules/          # 预装模块
│   └── examples/         # 示例代码
└── include/
    └── chtl/             # C++ API头文件
```

## 未来规划

1. **WebAssembly支持**: 编译到WASM
2. **增量编译**: 只重编译修改部分
3. **热重载**: 开发时实时更新
4. **云端编译**: 在线编译服务