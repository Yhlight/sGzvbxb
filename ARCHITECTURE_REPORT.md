# CHTL编译器架构重构报告

## 重构日期
2024年

## 架构设计目标
明确将CHTL和CHTL JS（手写编译器）与CSS以及JS（ANTLR原生编译器）独立开来，避免编译器之间的混合连接。

## 新架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                         CHTL源代码                               │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CHTLUnifiedScanner                           │
│                   (精准代码切割器)                               │
└─────────────────────────────┬───────────────────────────────────┘
                              │
                              ▼
        ┌──────────────┬──────────────┬──────────────┬────────────┐
        │   CHTL片段   │ CHTL JS片段  │   CSS片段    │   JS片段   │
        └──────┬───────┴──────┬───────┴──────┬───────┴──────┬─────┘
               │              │              │              │
               ▼              ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    CompilerDispatcher                           │
│                   (编译器调度器)                                 │
└──────┬──────────────┬──────────────┬──────────────┬────────────┘
       │              │              │              │
       ▼              ▼              ▼              ▼
┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
│    CHTL     │ │   CHTL JS   │ │     CSS     │ │JavaScript   │
│  Compiler   │ │  Compiler   │ │  Compiler   │ │  Compiler   │
│  (手写)     │ │  (手写)     │ │  (ANTLR)    │ │  (ANTLR)    │
└─────────────┘ └─────────────┘ └─────────────┘ └─────────────┘
       │              │              │              │
       └──────────────┴──────────────┴──────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      编译结果合并                                │
│                     (HTML输出)                                   │
└─────────────────────────────────────────────────────────────────┘
```

## 关键组件说明

### 1. 扫描器（CHTLUnifiedScanner）
- **职责**：精准切割源代码为不同语言片段
- **特点**：
  - 识别CHTL标记、CHTL JS、CSS和原生JS代码块
  - 保持源代码位置信息用于错误报告
  - 不进行任何编译，只负责切割

### 2. 编译器调度器（CompilerDispatcher）
- **职责**：根据片段类型分发到对应编译器
- **特点**：
  - 完全解耦不同编译器
  - 统一的编译器接口（ICompiler）
  - 支持编译器工厂模式

### 3. 四个独立编译器

#### 3.1 CHTL编译器（手写）
- **位置**：`src/chtl/compiler/handwritten/CHTLCompilerWrapper.h`
- **实现**：使用手写的CHTLParser
- **输出**：HTML结构

#### 3.2 CHTL JS编译器（手写）
- **位置**：`src/chtl/compiler/handwritten/CHTLJSCompilerWrapper.h`
- **实现**：使用手写的CHTLJSParser
- **输出**：增强的JavaScript代码

#### 3.3 CSS编译器（ANTLR）
- **位置**：`src/chtl/compiler/antlr/CSSCompilerWrapper.h`
- **实现**：使用ANTLR生成的CSS解析器
- **输出**：优化的CSS代码

#### 3.4 JavaScript编译器（ANTLR）
- **位置**：`src/chtl/compiler/antlr/JSCompilerWrapper.h`
- **实现**：使用ANTLR生成的JavaScript解析器
- **输出**：优化的JavaScript代码

## 重构完成的工作

### ✅ 已完成
1. **创建统一编译器接口**
   - `CompilerInterface.h` - 定义ICompiler和ICompilerFactory接口
   - 所有编译器必须实现此接口

2. **分离手写编译器**
   - `CHTLCompilerWrapper` - 包装手写的CHTL解析器
   - `CHTLJSCompilerWrapper` - 包装手写的CHTL JS解析器

3. **分离ANTLR编译器**
   - `CSSCompilerWrapper` - 包装ANTLR生成的CSS解析器
   - `JSCompilerWrapper` - 包装ANTLR生成的JavaScript解析器

4. **创建编译器调度器**
   - `CompilerDispatcher` - 负责片段分发和结果合并
   - 支持编译器注册和动态调度

5. **创建主编译器**
   - `CHTLMainCompiler` - 新的主编译器入口
   - 清晰的编译流程：扫描 -> 分发 -> 编译 -> 合并

### 🔄 待完成
1. **实现编译器包装器**
   - 需要实现各个Wrapper的compile方法
   - 适配现有编译器到新接口

2. **更新CMakeLists.txt**
   - 添加新的源文件
   - 组织编译目标

3. **测试新架构**
   - 创建测试用例
   - 验证编译流程

## 架构优势

1. **清晰分离**：手写编译器和ANTLR编译器完全独立
2. **易于扩展**：通过工厂模式可以轻松添加新编译器
3. **统一接口**：所有编译器实现相同接口，便于管理
4. **精准切割**：扫描器负责精确识别不同语言片段
5. **错误隔离**：各编译器的错误不会相互影响

## 下一步计划

1. 实现各编译器包装器的具体逻辑
2. 更新构建系统
3. 创建集成测试
4. 优化扫描器的切割精度
5. 完善错误报告机制

## 总结

新架构成功实现了CHTL项目的核心要求：
- **两个手写编译器**：CHTL和CHTL JS
- **两个ANTLR编译器**：CSS和JavaScript
- **完全独立**：四个编译器之间没有任何耦合
- **精准分发**：通过扫描器和调度器实现准确的代码片段分发

这种架构设计确保了系统的模块化、可维护性和可扩展性。